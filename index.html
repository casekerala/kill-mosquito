<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kill Mosquito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: #050816;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      overflow: hidden;
      text-align: center;
      padding-top: 1rem;
    }

    h1 {
      margin-bottom: 0.25rem;
      font-size: 2rem;
    }

    p {
      margin-top: 0;
      opacity: 0.8;
    }

    #game-area {
      position: relative;
      width: 90vw;
      max-width: 500px;
      height: 50vh;
      max-height: 420px;
      border-radius: 16px;
      border: 1px solid #333;
      background: radial-gradient(circle at top, #1b2735, #090a0f);
      overflow: hidden;
      cursor: crosshair;
      margin-top: 1rem;
    }

    #mosquito {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.1s;
    }

    /* blood splatter */
    #blood {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(255, 0, 0, 0.9) 0%,
        rgba(120, 0, 0, 0.7) 60%,
        transparent 70%
      );
      pointer-events: none;
      opacity: 0;
      transform: scale(0.2);
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }

    #blood.show {
      opacity: 1;
      transform: scale(1);
    }

    #stats {
      margin-top: 0.75rem;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }

    #kill-count {
      font-weight: bold;
      font-size: 1.1rem;
    }

    #global-count {
      font-size: 0.9rem;
      opacity: 0.95;
    }

    #message {
      font-size: 0.9rem;
      opacity: 0.85;
      max-width: 420px;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.45rem 1.1rem;
      border-radius: 999px;
      border: none;
      background: #f97316;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      filter: brightness(1.1);
    }

    #player-section {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }

    #player-name {
      font-weight: 600;
    }

    #name-form {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    #name-input {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #444;
      background: #020617;
      color: #f9fafb;
      min-width: 160px;
    }

    #leaderboard {
      margin-top: 1rem;
      width: 90vw;
      max-width: 480px;
      text-align: left;
      font-size: 0.9rem;
    }

    #leaderboard h2 {
      font-size: 1rem;
      margin: 0 0 0.35rem 0;
    }

    #leaderboard-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      border-radius: 12px;
      border: 1px solid #27272a;
      background: #020617;
      max-height: 200px;
      overflow-y: auto;
    }

    #leaderboard-list li {
      padding: 0.4rem 0.7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #18181b;
    }

    #leaderboard-list li:last-child {
      border-bottom: none;
    }

    .lb-name {
      max-width: 60%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lb-kills {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    #leaderboard-note {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      opacity: 0.6;
    }

    @media (max-height: 700px) {
      #game-area {
        height: 45vh;
      }
    }
  </style>
</head>
<body>
  <h1>Kill Mosquito</h1>
  <p>Got bitten? Missed the mosquito? Kill it here ðŸ¦Ÿ</p>

  <div id="game-area">
    <div id="mosquito">ðŸ¦Ÿ</div>
    <div id="blood"></div>
  </div>

  <div id="stats">
    <div id="kill-count">Your mosquitoes killed: 0</div>
    <div id="global-count">Global mosquitoes killed: 0</div>
    <div id="message">Click the mosquito to avenge your bite.</div>
    <button id="rage-button">I got bitten again ðŸ˜¡</button>
    <div id="player-section">
      <div id="player-info">
        You are playing as <span id="player-name">Anonymous slayer</span>
      </div>
      <div id="name-form">
        <input
          id="name-input"
          maxlength="20"
          placeholder="Enter a nickname"
          autocomplete="off"
        />
        <button id="save-name-button">Save name</button>
      </div>
    </div>
    
    <div id="leaderboard">
      <h2>Top mosquito killers</h2>
      <ol id="leaderboard-list">
        <!-- leaderboard rows inserted by JS -->
      </ol>
      <div id="leaderboard-note">
        Leaderboard is based on total kills per player
      </div>
    </div>
  </div>

  

  <div id="leaderboard">
    <h2>Top mosquito killers</h2>
    <ol id="leaderboard-list">
      <!-- leaderboard rows inserted by JS -->
    </ol>
    <div id="leaderboard-note">
      Leaderboard is based on total kills per player (per browser/device).
    </div>
  </div>

  <!-- All JS in one ES module -->
  <script type="module">
    /***********************
     *  Firebase Imports   *
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      increment,
      collection,
      query,
      orderBy,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    /*******************************
     *  Firebase Configuration     *
     *******************************
     * IMPORTANT:
     * Replace the placeholder values below with
     * the actual config from your Firebase console.
     */
     const firebaseConfig = {
  apiKey: "AIzaSyCgwe5bBUauwInzqcdCO1UXU01OBYd7x10",
  authDomain: "kill-mosquito.firebaseapp.com",
  projectId: "kill-mosquito",
  storageBucket: "kill-mosquito.firebasestorage.app",
  messagingSenderId: "204577376592",
  appId: "1:204577376592:web:6a1a51f8152b17d2888455",
  measurementId: "G-NXBHJN59CM"
};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /***********************
     *  DOM Elements       *
     ***********************/
    const gameArea = document.getElementById("game-area");
    const mosquito = document.getElementById("mosquito");
    const blood = document.getElementById("blood");
    const killCountText = document.getElementById("kill-count");
    const globalCountText = document.getElementById("global-count");
    const messageText = document.getElementById("message");
    const rageButton = document.getElementById("rage-button");

    const playerNameSpan = document.getElementById("player-name");
    const nameInput = document.getElementById("name-input");
    const saveNameButton = document.getElementById("save-name-button");
    const leaderboardList = document.getElementById("leaderboard-list");

    /***********************
     *  Game State         *
     ***********************/
    const mosquitoTypes = [
      { name: "Classic Mosquito", emoji: "ðŸ¦Ÿ", size: 50, moveEveryMs: 700 },
      { name: "Fast Mosquito", emoji: "ðŸª°", size: 45, moveEveryMs: 450 },
      { name: "Boss Spider", emoji: "ðŸ•·ï¸", size: 55, moveEveryMs: 550 }
    ];

    let currentTypeIndex = 0;
    let moveInterval = null;
    let mosquitoBoxSize = mosquitoTypes[0].size;

    // Per-player state
    let currentUserId = null;
    let currentNickname = "Anonymous slayer";
    let kills = 0; // total kills for this user (synced with Firestore)
    let globalKills = 0; // from stats/global

    /***********************
     *  Firestore Helpers  *
     ***********************/
    async function fetchGlobalKills() {
      try {
        const docRefFS = doc(db, "stats", "global");
        const snap = await getDoc(docRefFS);

        if (snap.exists()) {
          const data = snap.data();
          globalKills = data.globalKills || 0;
        } else {
          await setDoc(docRefFS, { globalKills: 0 });
          globalKills = 0;
        }
      } catch (err) {
        console.error("Error fetching global kills:", err);
      }
      updateCounts();
    }

    async function incrementGlobalKills(amount = 1) {
      try {
        const docRefFS = doc(db, "stats", "global");
        await updateDoc(docRefFS, { globalKills: increment(amount) });
        globalKills += amount;
      } catch (err) {
        console.error("Error updating global kills:", err);
      }
      updateCounts();
    }

    function updateCounts() {
      killCountText.textContent = "Your mosquitoes killed: " + kills;
      globalCountText.textContent = "Global mosquitoes killed: " + globalKills;
    }

    async function initUserDocument(uid) {
      const userRef = doc(db, "users", uid);
      try {
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          kills = typeof data.totalKills === "number" ? data.totalKills : 0;
          currentNickname = data.nickname || currentNickname;
        } else {
          await setDoc(userRef, {
            nickname: currentNickname,
            totalKills: 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          kills = 0;
        }

        // sync to localStorage (optional, just for device persistence)
        localStorage.setItem("killMosquito_kills", String(kills));

        playerNameSpan.textContent = currentNickname;
        nameInput.value = currentNickname;
        updateCounts();
        await loadLeaderboard();
      } catch (err) {
        console.error("Error initializing user document:", err);
      }
    }

    async function updateUserKills(incrementBy = 1) {
      if (!currentUserId) return;
      const userRef = doc(db, "users", currentUserId);
      try {
        await updateDoc(userRef, {
          totalKills: increment(incrementBy),
          updatedAt: serverTimestamp()
        });
      } catch (err) {
        console.error("Error updating user kills:", err);
      }
    }

    async function updateUserNickname(newName) {
      if (!currentUserId) return;
      const userRef = doc(db, "users", currentUserId);
      try {
        await updateDoc(userRef, {
          nickname: newName,
          updatedAt: serverTimestamp()
        });
      } catch (err) {
        console.error("Error updating nickname:", err);
      }
    }

    async function loadLeaderboard() {
      try {
        const usersRef = collection(db, "users");
        const q = query(usersRef, orderBy("totalKills", "desc"), limit(10));
        const snapshot = await getDocs(q);

        leaderboardList.innerHTML = "";

        let rank = 1;
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const name = data.nickname || "Unknown hunter";
          const total = data.totalKills || 0;

          const li = document.createElement("li");

          const nameSpan = document.createElement("span");
          nameSpan.className = "lb-name";
          nameSpan.textContent = `${rank}. ${name}`;

          const killsSpan = document.createElement("span");
          killsSpan.className = "lb-kills";
          killsSpan.textContent = `${total} ðŸ¦Ÿ`;

          li.appendChild(nameSpan);
          li.appendChild(killsSpan);
          leaderboardList.appendChild(li);

          rank++;
        });

        if (!leaderboardList.children.length) {
          const li = document.createElement("li");
          li.textContent = "No killers yet. Be the first.";
          leaderboardList.appendChild(li);
        }
      } catch (err) {
        console.error("Error loading leaderboard:", err);
      }
    }

    /***********************
     *  Game Functions     *
     ***********************/
    function randomPosition() {
      const areaRect = gameArea.getBoundingClientRect();
      const size = mosquitoBoxSize;
      const x = Math.random() * (areaRect.width - size);
      const y = Math.random() * (areaRect.height - size);
      mosquito.style.left = x + "px";
      mosquito.style.top = y + "px";
    }

    function setMosquitoType(index) {
      currentTypeIndex = Math.max(0, Math.min(index, mosquitoTypes.length - 1));
      const type = mosquitoTypes[currentTypeIndex];

      mosquito.textContent = type.emoji;
      mosquito.style.width = type.size + "px";
      mosquito.style.height = type.size + "px";
      mosquitoBoxSize = type.size;

      if (moveInterval) clearInterval(moveInterval);
      moveInterval = setInterval(randomPosition, type.moveEveryMs);

      randomPosition();
    }

    /***********************
     *  Sound (Web Audio)  *
     ***********************/
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioCtx();

    function playPop() {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "square";
      osc.frequency.setValueAtTime(400, audioCtx.currentTime);

      gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(
        0.001,
        audioCtx.currentTime + 0.15
      );

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.15);
    }

    /***********************
     *  Blood Effect       *
     ***********************/
    function showBlood() {
      const mosRect = mosquito.getBoundingClientRect();
      const areaRect = gameArea.getBoundingClientRect();

      const bloodSize = 40;
      const centerX = mosRect.left - areaRect.left + mosRect.width / 2;
      const centerY = mosRect.top - areaRect.top + mosRect.height / 2;

      blood.style.left = centerX - bloodSize / 2 + "px";
      blood.style.top = centerY - bloodSize / 2 + "px";

      blood.classList.add("show");
      setTimeout(() => blood.classList.remove("show"), 250);
    }

    function randomKillMessage() {
      const messages = [
        "Nice shot. Your blood is avenged. ðŸ©¸",
        "Rest in pieces, mosquito. ðŸ’€",
        "Critical hit! No more buzzing. ðŸ”‡",
        "Another one bites the dust. ðŸŽ¯",
        "Youâ€™re a certified mosquito hunter now. ðŸ…",
        "Mosquito population: -1. Keep going. ðŸ“‰"
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    }

    /***********************
     *  Event Listeners    *
     ***********************/
    mosquito.addEventListener("click", async () => {
      if (audioCtx.state === "suspended") {
        try {
          await audioCtx.resume();
        } catch (e) {}
      }

      // local state
      kills++;
      localStorage.setItem("killMosquito_kills", String(kills));
      updateCounts();

      // global + user updates
      incrementGlobalKills(1);
      updateUserKills(1);
      loadLeaderboard();

      // UI feedback
      messageText.textContent = randomKillMessage();
      playPop();
      showBlood();

      mosquito.style.transform = "scale(0.6)";
      setTimeout(() => {
        mosquito.style.transform = "scale(1)";
        randomPosition();
      }, 120);

      // Level up mosquito type every 10 kills
      const nextIndex = Math.floor(kills / 10);
      if (nextIndex > currentTypeIndex && nextIndex < mosquitoTypes.length) {
        setMosquitoType(nextIndex);
        messageText.textContent =
          "New enemy unlocked: " + mosquitoTypes[nextIndex].name + " âš ï¸";
      }
    });

    rageButton.addEventListener("click", () => {
      messageText.textContent = "Rage accepted. Spawning more targetsâ€¦ ðŸ’¢";
      randomPosition();
    });

    saveNameButton.addEventListener("click", async () => {
      const newName = nameInput.value.trim();
      if (!newName) return;
      currentNickname = newName;
      playerNameSpan.textContent = newName;
      if (currentUserId) {
        await updateUserNickname(newName);
        loadLeaderboard();
      }
    });

    /***********************
 *  Firebase Auth Init *
 ***********************/
/***********************
 *  Firebase Auth Init *
 ***********************/
 async function initAuthAndUser() {
  try {
    // sign in anonymously if not already signed in
    if (!auth.currentUser) {
      const result = await signInAnonymously(auth);
      currentUserId = result.user.uid;
      console.log("Signed in anonymously:", currentUserId);
    } else {
      currentUserId = auth.currentUser.uid;
      console.log("Already signed in as:", currentUserId);
    }

    await initUserDocument(currentUserId);
  } catch (err) {
    console.error("Error with anonymous auth:", err);
  }
}


// call this once when the page loads (near the bottom of the script)
initAuthAndUser();

    

    // Also store nickname locally when changed
    nameInput.addEventListener("change", () => {
      const val = nameInput.value.trim();
      if (val) {
        localStorage.setItem("killMosquito_name", val);
      }
    });

    /***********************
     *  Init on Page Load  *
     ***********************/
    // initial UI using local storage before Firestore arrives (optional)
    const localKills = parseInt(
      localStorage.getItem("killMosquito_kills") || "0",
      10
    );
    if (!Number.isNaN(localKills)) {
      kills = localKills;
    }

    const localName = localStorage.getItem("killMosquito_name");
    if (localName) {
      currentNickname = localName;
      playerNameSpan.textContent = localName;
      nameInput.value = localName;
    }

    updateCounts();
    setMosquitoType(0);
    fetchGlobalKills();
    loadLeaderboard();

    initAuthAndUser();   // ðŸ”¥ this line must exist


  </script>
</body>
</html>
